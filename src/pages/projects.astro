---
export const prerender = true

import Layout from '../layouts/Layout.astro'
import BoardingPass from '../components/BoardingPass.astro'
import Header from '../components/Header.astro'
import PageWrapper from '../components/PageWrapper.astro'
import PageHeader from '../components/PageHeader.astro'
import { formatImageUrlWithSize, safeFetchCollection } from '../lib/strapi'
import type { ProjectContent } from '../types/strapi'

const ANIMATION_DELAY_MS = 100

// Project images: h-32 (128px height), w-full (responsive, max container ~1152px)
// Images display at ~624px width on typical screens
// Generate multiple sizes for responsive images:
// - 400px for mobile (1x) and small screens
// - 640px for typical desktop displays (matches ~624px display width)
// - 800px for high-DPI displays (1.25x) and larger screens
const PROJECT_IMAGE_SIZE_MOBILE = 400
const PROJECT_IMAGE_SIZE_DESKTOP = 640
const PROJECT_IMAGE_SIZE_HIGH_DPI = 800
const PROJECT_IMAGE_SIZES = [
  PROJECT_IMAGE_SIZE_MOBILE,
  PROJECT_IMAGE_SIZE_DESKTOP,
  PROJECT_IMAGE_SIZE_HIGH_DPI,
]

const strapiProjects = await safeFetchCollection<ProjectContent>({
  endpoint: 'projects',
  query: {
    sort: 'createdAt:desc',
  },
  contentTypeName: 'projects',
  populate: 'image', // Only populate the image field for better performance
})

const projects = strapiProjects.map((project) => {
  // Handle image - could be single object or array
  const projectImage = Array.isArray(project.image)
    ? project.image[0]
    : project.image

  // Generate srcset with multiple sizes for responsive images
  const imageSrcSet = projectImage
    ? PROJECT_IMAGE_SIZES.map((width) => {
        const url = formatImageUrlWithSize(projectImage, width, 'webp')
        return `${url} ${width}w`
      }).join(', ')
    : undefined

  // Use the middle size (640px) as the default src for browsers that don't support srcset
  const imageUrl = projectImage
    ? formatImageUrlWithSize(projectImage, PROJECT_IMAGE_SIZE_DESKTOP, 'webp')
    : undefined

  return {
    projectName: project.projectName,
    completedYear: project.completedYear,
    technologies: project.technologies,
    description: project.description,
    liveUrl: project.liveUrl,
    githubUrl: project.githubUrl,
    imageUrl,
    imageSrcSet,
  }
})
---

<Layout title="Lucas Silbernagel | Projects">
  <Header showBackButton={true} />
  <PageWrapper>
    <PageHeader title="Projects" subtitle="My most recent side projects" />

    <div class="mx-auto max-w-6xl space-y-8">
      {
        projects.map((project, index) => (
          <div
            class="animate-fade-in"
            style={`animation-delay: ${index * ANIMATION_DELAY_MS}ms`}
          >
            <BoardingPass
              projectName={project.projectName}
              completedYear={project.completedYear}
              technologies={project.technologies}
              description={project.description}
              liveUrl={project.liveUrl}
              githubUrl={project.githubUrl}
              imageUrl={project.imageUrl}
              imageSrcSet={project.imageSrcSet}
              isFirst={index === 0}
            />
          </div>
        ))
      }
    </div>
  </PageWrapper>
</Layout>

<style>
  .animate-fade-in {
    opacity: 0;
    animation: fadeInUp 0.6s ease-out forwards;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .animate-fade-in {
      animation: none;
      opacity: 1;
      transform: none;
    }
  }
</style>
