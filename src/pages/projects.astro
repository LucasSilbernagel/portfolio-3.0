---
import Layout from '../layouts/Layout.astro'
import BoardingPass from '../components/BoardingPass.astro'
import Header from '../components/Header.astro'
import PageWrapper from '../components/PageWrapper.astro'
import PageHeader from '../components/PageHeader.astro'
import fetchApi, { formatImageUrl } from '../lib/strapi'
import type { ProjectContent } from '../types/strapi'

const ANIMATION_DELAY_MS = 100

let strapiProjects: ProjectContent[]

try {
  strapiProjects = await fetchApi<ProjectContent[]>({
    endpoint: 'projects',
    query: {
      populate: '*',
      sort: 'createdAt:desc',
    },
    wrappedByKey: 'data',
  })
} catch (error) {
  // eslint-disable-next-line no-console
  console.warn(
    `Failed to fetch projects from Strapi: ${error instanceof Error ? error.message : String(error)}.`
  )
  strapiProjects = []
}

const projects = strapiProjects.map((project) => {
  // Handle image - could be single object or array
  const projectImage = Array.isArray(project.image)
    ? project.image[0]
    : project.image
  const imageUrl = projectImage ? formatImageUrl(projectImage) : undefined

  return {
    projectName: project.projectName,
    completedYear: project.completedYear,
    technologies: project.technologies,
    description: project.description,
    liveUrl: project.liveUrl,
    githubUrl: project.githubUrl,
    imageUrl,
  }
})
---

<Layout title="Lucas Silbernagel | Projects">
  <Header showBackButton={true} />
  <PageWrapper>
    <PageHeader title="Projects" subtitle="My most recent side projects" />

    <div class="mx-auto max-w-6xl space-y-8">
      {
        projects.map((project, index) => (
          <div
            class="animate-fade-in"
            style={`animation-delay: ${index * ANIMATION_DELAY_MS}ms`}
          >
            <BoardingPass
              projectName={project.projectName}
              completedYear={project.completedYear}
              technologies={project.technologies}
              description={project.description}
              liveUrl={project.liveUrl}
              githubUrl={project.githubUrl}
              imageUrl={project.imageUrl}
            />
          </div>
        ))
      }
    </div>
  </PageWrapper>
</Layout>

<style>
  .animate-fade-in {
    opacity: 0;
    animation: fadeInUp 0.6s ease-out forwards;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .animate-fade-in {
      animation: none;
      opacity: 1;
      transform: none;
    }
  }
</style>
