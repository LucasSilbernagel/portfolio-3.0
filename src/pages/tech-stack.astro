---
import Layout from '../layouts/Layout.astro'
import Header from '../components/Header.astro'
import PageWrapper from '../components/PageWrapper.astro'
import PageHeader from '../components/PageHeader.astro'
import { Icon } from 'astro-icon/components'
import fetchApi from '../lib/strapi'
import type { TechStackContent } from '../types/strapi'

const ANIMATION_DELAY_MS = 100
const INITIAL_ANIMATION_DELAY = 2
const ICONS_PER_SIDE = 4
const DECORATIVE_ICON_BASE_DELAY_MS = 500
const DECORATIVE_ICON_STAGGER_MS = 150

const decorativeIcons = [
  'mdi:language-html5',
  'mdi:language-css3',
  'mdi:language-javascript',
  'mdi:language-typescript',
  'mdi:react',
  'mdi:graphql',
  'mdi:tailwind',
  'mdi:nodejs',
]

let strapiResponse: TechStackContent | null

try {
  strapiResponse = await fetchApi<TechStackContent | null>({
    endpoint: 'tech-stack',
    query: {
      populate: '*',
    },
    wrappedByKey: 'data',
  })
} catch (error) {
  throw new Error(
    `Failed to fetch content from Strapi: ${error instanceof Error ? error.message : String(error)}. Make sure Strapi is running and the Tech Stack content type has public permissions enabled.`
  )
}

if (!strapiResponse) {
  throw new Error(
    'Tech stack content not found in Strapi. Please:\n1. Create and publish the content in the Strapi admin panel\n2. Go to Settings > Users & Permissions Plugin > Roles > Public\n3. Enable "find" permission for "Tech Stack"'
  )
}

// Validate required fields
if (
  !strapiResponse.technologies ||
  !Array.isArray(strapiResponse.technologies)
) {
  throw new Error(
    'Tech stack technologies field is required and must be an array'
  )
}

const techStack = strapiResponse.technologies
---

<Layout title="Lucas Silbernagel | Tech Stack">
  <Header showBackButton={true} />
  <PageWrapper class="relative">
    <PageHeader
      title="Tech Stack"
      titleClass="fade-in-1 mb-4 text-4xl font-bold text-white md:text-5xl"
    />

    <div class="relative">
      <div
        class="decorative-icons-wrapper pointer-events-none absolute inset-0 z-0"
      >
        <div
          class="decorative-icons-inner container mx-auto flex h-full w-full items-center justify-between px-8"
        >
          <div class="decorative-icons-column">
            {
              decorativeIcons.slice(0, ICONS_PER_SIDE).map((iconName, i) => (
                <div
                  class="decorative-icon"
                  data-icon-index={i}
                  style={`animation-delay: ${DECORATIVE_ICON_BASE_DELAY_MS + i * DECORATIVE_ICON_STAGGER_MS}ms`}
                >
                  <Icon name={iconName} />
                </div>
              ))
            }
          </div>

          <div class="decorative-icons-column">
            {
              decorativeIcons.slice(ICONS_PER_SIDE).map((iconName, i) => (
                <div
                  class="decorative-icon"
                  data-icon-index={i + ICONS_PER_SIDE}
                  style={`animation-delay: ${DECORATIVE_ICON_BASE_DELAY_MS + (i + ICONS_PER_SIDE) * DECORATIVE_ICON_STAGGER_MS}ms`}
                >
                  <Icon name={iconName} />
                </div>
              ))
            }
          </div>
        </div>
      </div>

      <div class="relative z-10 mx-auto max-w-4xl">
        <div class="kiosk-tile fade-in-2 p-2 sm:p-5">
          <div class="overflow-x-auto overflow-y-hidden">
            <table class="w-full border-collapse">
              <thead>
                <tr class="border-b-2 border-terminal-blue">
                  <th
                    class="px-4 py-4 text-left text-lg font-bold text-terminal-dark-gray sm:px-6"
                  >
                    Category
                  </th>
                  <th
                    class="px-4 py-4 text-left text-lg font-bold text-terminal-dark-gray sm:px-6"
                  >
                    Technologies
                  </th>
                </tr>
              </thead>
              <tbody>
                {
                  techStack.map((item, index) => (
                    <tr
                      class="border-b-2 border-gray-300"
                      style={`animation-delay: ${(index + INITIAL_ANIMATION_DELAY) * ANIMATION_DELAY_MS}ms`}
                    >
                      <td class="px-4 py-4 font-semibold text-terminal-dark-gray sm:px-6">
                        {item.category}
                      </td>
                      <td class="px-4 py-4 text-terminal-dark-gray sm:px-6">
                        <div class="flex flex-wrap gap-2">
                          {item.items.map((tech) => (
                            <span class="inline-block rounded-md bg-terminal-blue px-4 py-2 text-sm font-medium text-white">
                              {tech}
                            </span>
                          ))}
                        </div>
                      </td>
                    </tr>
                  ))
                }
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </PageWrapper>
</Layout>

<style>
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Respect reduced motion preferences */
  @media (prefers-reduced-motion: reduce) {
    .fade-in-1,
    .fade-in-2,
    tr,
    .decorative-icon {
      animation: none;
      opacity: 1;
      transform: none;
    }
  }

  /* Fade-in animations with staggered delays */
  .fade-in-1 {
    opacity: 0;
    animation: fadeIn 0.6s ease-out forwards;
    animation-delay: 0ms;
  }

  .fade-in-2 {
    opacity: 0;
    animation: fadeIn 0.6s ease-out forwards;
    animation-delay: 300ms;
  }

  .kiosk-tile {
    padding: 0;
  }

  tbody tr {
    opacity: 0;
    animation: fadeIn 0.4s ease-out forwards;
    border-bottom: 2px solid #d1d5db;
  }

  tbody tr:last-child {
    border-bottom: none;
  }

  /* Ensure badge styles are applied */
  td span.inline-block {
    display: inline-block;
    padding: 0.5rem 1rem;
    background-color: #0066cc;
    color: white;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
  }

  .decorative-icons-wrapper {
    display: none;
  }

  .decorative-icon {
    opacity: 0;
    transform: translateY(20px);
    animation: fadeIn 0.6s ease-out forwards;
  }

  @media (min-width: 1300px) {
    .decorative-icons-wrapper {
      display: flex;
      align-items: flex-start;
    }

    .decorative-icons-inner {
      display: flex;
    }

    .decorative-icons-column {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3rem;
    }

    .decorative-icon {
      display: flex;
      height: 6rem;
      width: 6rem;
      min-height: 5rem;
      min-width: 5rem;
      flex-shrink: 0;
      align-items: center;
      justify-content: center;
      border-radius: 9999px;
      background-color: #0066cc;
    }

    .decorative-icon svg {
      width: 4rem;
      height: 4rem;
      display: block;
      fill: white;
    }

    .decorative-icon .astro-icon {
      display: block;
    }
  }
</style>
