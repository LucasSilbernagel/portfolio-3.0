---
export const prerender = true

import Layout from '../layouts/Layout.astro'
import Header from '../components/Header.astro'
import PageWrapper from '../components/PageWrapper.astro'
import PageHeader from '../components/PageHeader.astro'
import { Icon } from 'astro-icon/components'
import { fetchCollectionWithValidation } from '../lib/strapi'
import type { ExperienceItem, BlockType } from '../types/strapi'

const ANIMATION_DELAY_STEP_MS = 120

const strapiResponse = await fetchCollectionWithValidation<ExperienceItem>({
  endpoint: 'experiences',
  query: {
    sort: 'startDate:desc',
  },
  contentTypeName: 'Experience',
})

// Handle empty response in CI builds
const experiences = strapiResponse || []

// Format date to period string
// Parse date string (YYYY-MM-DD) as local date to avoid timezone issues
const parseLocalDate = (dateString: string): Date => {
  const [year, month, day] = dateString.split('-').map(Number)
  // month is 0-indexed in Date constructor
  return new Date(year, month - 1, day)
}

type PeriodParts = {
  startMonth: string
  startYear: number
  endMonth: string | null
  endYear: number | null
  isPresent: boolean
  isSamePeriod: boolean
}

const formatPeriod = (
  startDate: string,
  endDate: string | null
): PeriodParts => {
  const start = parseLocalDate(startDate)
  const startMonth = start.toLocaleDateString('en-US', { month: 'long' })
  const startYear = start.getFullYear()

  if (!endDate) {
    return {
      startMonth,
      startYear,
      endMonth: null,
      endYear: null,
      isPresent: true,
      isSamePeriod: false,
    }
  }

  const end = parseLocalDate(endDate)
  const endMonth = end.toLocaleDateString('en-US', { month: 'long' })
  const endYear = end.getFullYear()

  // If same month and year, return just the month and year
  if (startMonth === endMonth && startYear === endYear) {
    return {
      startMonth,
      startYear,
      endMonth: null,
      endYear: null,
      isPresent: false,
      isSamePeriod: true,
    }
  }

  return {
    startMonth,
    startYear,
    endMonth,
    endYear,
    isPresent: false,
    isSamePeriod: false,
  }
}

// Extract text from blocks content
const extractHighlights = (highlights: unknown): string[] => {
  if (typeof highlights === 'string') {
    return highlights.split('\n').filter((line) => line.trim())
  }

  if (Array.isArray(highlights)) {
    return highlights
      .map((block: unknown) => {
        if (typeof block === 'object' && block !== null && 'type' in block) {
          const blockObj = block as BlockType
          if (blockObj.type === 'paragraph' && blockObj.children) {
            return blockObj.children.map((child) => child.text || '').join('')
          }
        }
        return null
      })
      .filter((text): text is string => text !== null && text.trim() !== '')
  }

  return []
}
---

<Layout title="Lucas Silbernagel | Experience">
  <Header showBackButton={true} />
  <PageWrapper>
    <div class="mx-auto max-w-4xl">
      <PageHeader title="Professional Experience" class="mt-4" />

      <ol
        class="timeline-list mx-auto mt-16 max-w-5xl space-y-16"
        aria-label="Professional experience timeline"
      >
        {
          experiences.map((experience, index) => (
            <li
              class="timeline-item group grid gap-6 sm:grid-cols-[4rem_1fr]"
              style={`--timeline-delay: ${index * ANIMATION_DELAY_STEP_MS}ms`}
            >
              <div
                class="relative flex flex-col items-center"
                aria-hidden="true"
              >
                <span
                  class={`w-px flex-1 ${
                    index === 0 ? 'bg-transparent' : 'bg-terminal-blue/40'
                  }`}
                />
                <span class="mt-0 flex h-6 w-6 items-center justify-center rounded-full border-[3px] border-terminal-dark-gray bg-terminal-yellow shadow-[0_0_0_8px_rgba(0,102,204,0.35)] transition-transform duration-300 group-focus-within:scale-105 group-hover:scale-105" />
                <span
                  class={`w-px flex-1 ${
                    index === experiences.length - 1
                      ? 'bg-transparent'
                      : 'bg-terminal-blue/40'
                  }`}
                />
              </div>

              <div class="experience-card relative overflow-hidden rounded-2xl border-4 border-terminal-blue bg-white/95 p-6 text-left text-terminal-dark-gray shadow-[0_25px_60px_rgba(15,23,42,0.4)] backdrop-blur-md transition-shadow duration-300 group-focus-within:shadow-[0_25px_70px_rgba(15,23,42,0.55)] group-hover:shadow-[0_25px_70px_rgba(15,23,42,0.55)]">
                <header class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
                  <div>
                    <a
                      href={experience.Website}
                      class="inline-flex items-center gap-2 font-terminal text-lg uppercase tracking-[0.20em] text-terminal-dark-gray transition-colors hover:text-terminal-blue focus-visible:text-terminal-blue focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-terminal-blue"
                      target="_blank"
                      rel="noreferrer"
                      aria-label={`Company: ${experience.Company} (opens company website in a new tab)`}
                    >
                      {experience.Company} <Icon name="mdi:external-link" />
                    </a>
                    <h2 class="mt-2 text-2xl font-bold text-terminal-dark-gray sm:text-3xl">
                      {experience.Position}
                    </h2>
                  </div>
                  <div class="flex flex-col text-sm text-terminal-dark-gray/80 sm:items-end">
                    <span
                      class="font-semibold text-terminal-blue"
                      aria-label={(() => {
                        const period = formatPeriod(
                          experience.startDate,
                          experience.endDate
                        )
                        if (period.isSamePeriod) {
                          return `${period.startMonth} ${period.startYear}`
                        }
                        if (period.isPresent) {
                          return `${period.startMonth} ${period.startYear} through present`
                        }
                        return `${period.startMonth} ${period.startYear} through ${period.endMonth} ${period.endYear}`
                      })()}
                    >
                      {(() => {
                        const period = formatPeriod(
                          experience.startDate,
                          experience.endDate
                        )
                        if (period.isSamePeriod) {
                          return `${period.startMonth} ${period.startYear}`
                        }
                        if (period.isPresent) {
                          return (
                            <>
                              {`${period.startMonth} ${period.startYear}`}
                              <span aria-hidden="true"> - </span>
                              present
                            </>
                          )
                        }
                        return (
                          <>
                            {`${period.startMonth} ${period.startYear}`}
                            <span aria-hidden="true"> - </span>
                            {`${period.endMonth} ${period.endYear}`}
                          </>
                        )
                      })()}
                    </span>
                    <span>{experience.Location}</span>
                  </div>
                </header>

                <ul
                  class="mt-6 space-y-3 text-base leading-relaxed"
                  role="list"
                >
                  {extractHighlights(experience.Highlights).map((highlight) => (
                    <li class="flex gap-3">
                      <span class="mt-2 h-2 w-2 flex-shrink-0 rounded-full bg-terminal-blue" />
                      <p>{highlight}</p>
                    </li>
                  ))}
                </ul>
              </div>
            </li>
          ))
        }
      </ol>
    </div>
  </PageWrapper>
</Layout>

<style>
  .timeline-list {
    position: relative;
  }

  .timeline-item {
    opacity: 0;
    transform: translateY(24px) translateZ(0);
    animation: timelineFadeIn 0.8s ease-out forwards;
    animation-delay: var(--timeline-delay, 0ms);
    /* Optimize rendering during scroll */
    will-change: transform, opacity;
    backface-visibility: hidden;
  }

  @keyframes timelineFadeIn {
    from {
      opacity: 0;
      transform: translateY(24px) translateZ(0);
    }

    to {
      opacity: 1;
      transform: translateY(0) translateZ(0);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .timeline-item {
      animation: none;
      opacity: 1;
      transform: none;
    }

    .timeline-item span,
    .experience-card,
    .experience-card a {
      transition: none;
    }

    .timeline-item span:hover,
    .timeline-item span:focus,
    .experience-card:hover,
    .experience-card:focus {
      transform: none;
    }
  }

  .experience-card {
    /* Force GPU acceleration and prevent rendering artifacts during scroll */
    transform: translateZ(0);
    will-change: transform, opacity;
    /* Isolate rendering to prevent backdrop blur artifacts */
    isolation: isolate;
    /* Ensure proper compositing */
    backface-visibility: hidden;
  }
</style>
