---
import Layout from '../layouts/Layout.astro'
import Header from '../components/Header.astro'
import PageWrapper from '../components/PageWrapper.astro'
import PageHeader from '../components/PageHeader.astro'
import { Icon } from 'astro-icon/components'
import fetchApi from '../lib/strapi'
import type { ExperienceContent } from '../types/strapi'

const ANIMATION_DELAY_STEP_MS = 120

let strapiResponse: ExperienceContent | null

try {
  strapiResponse = await fetchApi<ExperienceContent | null>({
    endpoint: 'experience',
    query: {
      populate: '*',
    },
    wrappedByKey: 'data',
  })
} catch (error) {
  throw new Error(
    `Failed to fetch content from Strapi: ${error instanceof Error ? error.message : String(error)}. Make sure Strapi is running and the Experience content type has public permissions enabled.`
  )
}

if (!strapiResponse) {
  throw new Error(
    'Experience content not found in Strapi. Please:\n1. Create and publish the content in the Strapi admin panel\n2. Go to Settings > Users & Permissions Plugin > Roles > Public\n3. Enable "find" permission for "Experience"'
  )
}

// Validate required fields
if (!strapiResponse.experience || !Array.isArray(strapiResponse.experience)) {
  throw new Error(
    'Experience experience field is required and must be an array'
  )
}

const experiences = strapiResponse.experience
---

<Layout title="Lucas Silbernagel | Experience">
  <Header showBackButton={true} />
  <PageWrapper>
    <div class="mx-auto max-w-4xl">
      <PageHeader title="Professional Experience" class="mt-4" />

      <ol
        class="timeline-list mx-auto mt-16 max-w-5xl space-y-16"
        aria-label="Professional experience timeline"
      >
        {
          experiences.map((experience, index) => (
            <li
              class="timeline-item group grid gap-6 sm:grid-cols-[4rem_1fr]"
              style={`--timeline-delay: ${index * ANIMATION_DELAY_STEP_MS}ms`}
            >
              <div
                class="relative flex flex-col items-center"
                aria-hidden="true"
              >
                <span
                  class={`w-px flex-1 ${
                    index === 0 ? 'bg-transparent' : 'bg-terminal-blue/40'
                  }`}
                />
                <span class="mt-0 flex h-6 w-6 items-center justify-center rounded-full border-[3px] border-terminal-dark-gray bg-terminal-yellow shadow-[0_0_0_8px_rgba(0,102,204,0.35)] transition-transform duration-300 group-focus-within:scale-105 group-hover:scale-105" />
                <span
                  class={`w-px flex-1 ${
                    index === experiences.length - 1
                      ? 'bg-transparent'
                      : 'bg-terminal-blue/40'
                  }`}
                />
              </div>

              <div class="experience-card relative overflow-hidden rounded-2xl border-4 border-terminal-blue bg-white/95 p-6 text-left text-terminal-dark-gray shadow-[0_25px_60px_rgba(15,23,42,0.4)] backdrop-blur-md transition-shadow duration-300 group-focus-within:shadow-[0_25px_70px_rgba(15,23,42,0.55)] group-hover:shadow-[0_25px_70px_rgba(15,23,42,0.55)]">
                <header class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
                  <div>
                    <a
                      href={experience.website}
                      class="inline-flex items-center gap-2 font-terminal text-lg uppercase tracking-[0.20em] text-terminal-dark-gray transition-colors hover:text-terminal-blue focus-visible:text-terminal-blue focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-terminal-blue"
                      target="_blank"
                      rel="noreferrer"
                    >
                      {experience.company} <Icon name="mdi:external-link" />
                    </a>
                    <h2 class="mt-2 text-2xl font-bold text-terminal-dark-gray sm:text-3xl">
                      {experience.title}
                    </h2>
                  </div>
                  <div class="flex flex-col text-sm text-terminal-dark-gray/80 sm:items-end">
                    <span class="font-semibold text-terminal-blue">
                      {experience.period}
                    </span>
                    <span>{experience.location}</span>
                  </div>
                </header>

                <ul
                  class="mt-6 space-y-3 text-base leading-relaxed"
                  role="list"
                >
                  {experience.highlights.map((highlight) => (
                    <li class="flex gap-3">
                      <span class="mt-2 h-2 w-2 flex-shrink-0 rounded-full bg-terminal-blue" />
                      <p>{highlight}</p>
                    </li>
                  ))}
                </ul>
              </div>
            </li>
          ))
        }
      </ol>
    </div>
  </PageWrapper>
</Layout>

<style>
  .timeline-list {
    position: relative;
  }

  .timeline-item {
    opacity: 0;
    transform: translateY(24px) translateZ(0);
    animation: timelineFadeIn 0.8s ease-out forwards;
    animation-delay: var(--timeline-delay, 0ms);
    /* Optimize rendering during scroll */
    will-change: transform, opacity;
    backface-visibility: hidden;
  }

  @keyframes timelineFadeIn {
    from {
      opacity: 0;
      transform: translateY(24px) translateZ(0);
    }

    to {
      opacity: 1;
      transform: translateY(0) translateZ(0);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .timeline-item {
      animation: none;
      opacity: 1;
      transform: none;
    }

    .timeline-item span,
    .experience-card,
    .experience-card a {
      transition: none;
    }

    .timeline-item span:hover,
    .timeline-item span:focus,
    .experience-card:hover,
    .experience-card:focus {
      transform: none;
    }
  }

  .experience-card {
    /* Force GPU acceleration and prevent rendering artifacts during scroll */
    transform: translateZ(0);
    will-change: transform, opacity;
    /* Isolate rendering to prevent backdrop blur artifacts */
    isolation: isolate;
    /* Ensure proper compositing */
    backface-visibility: hidden;
  }
</style>
